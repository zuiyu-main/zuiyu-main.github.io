(window.webpackJsonp=window.webpackJsonp||[]).push([[31],{437:function(s,n,a){"use strict";a.r(n);var e=a(2),t=Object(e.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("在我们使用elasticsearch创建索引时，经常会遇到一种字段类型为"),n("code",[s._v("geo_point")]),s._v("的数据类型，该类型的字段接收经纬度的值，那么"),n("code",[s._v("geo_point")]),s._v("类型的字段可以用来做什么？")]),s._v(" "),n("ul",[n("li",[s._v("基于Geo的地理位置范围查询")]),s._v(" "),n("li",[s._v("基于Geo范围内到中心点距离的聚合统计")]),s._v(" "),n("li",[s._v("加入到相关性得分计算中")]),s._v(" "),n("li",[s._v("基于Geo地理位置信息到中心点距离的排序")])]),s._v(" "),n("p",[s._v("通过阅读本文，可以学到以上知识点，学到就是赚到，还不快快开始阅读吧")]),s._v(" "),n("h1",{attrs:{id:"环境"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#环境"}},[s._v("#")]),s._v(" 环境")]),s._v(" "),n("ul",[n("li",[s._v("MacOS 10.14.6")]),s._v(" "),n("li",[s._v("Elasticsearch 8.1")]),s._v(" "),n("li",[s._v("Kibana 8.1")])]),s._v(" "),n("h1",{attrs:{id:"帮助信息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#帮助信息"}},[s._v("#")]),s._v(" 帮助信息")]),s._v(" "),n("ul",[n("li",[n("p",[n("strong",[s._v("latitude: 纬度;longitude: 经度;")])])]),s._v(" "),n("li",[n("p",[s._v("获取地理位置坐标网站，看自己喜好")]),s._v(" "),n("blockquote",[n("p",[s._v("http://api.map.baidu.com/lbsapi/getpoint/index.html")]),s._v(" "),n("p",[s._v("http://jingweidu.757dy.com/")])])]),s._v(" "),n("li",[n("p",[s._v("geohash生成")]),s._v(" "),n("p",[s._v("如何获取一个地理位置的geohash以及根据geohash获取经纬度")]),s._v(" "),n("blockquote",[n("p",[s._v("https://www.dcode.fr/geohash-coordinates")])]),s._v(" "),n("p",[s._v("根据地理位置信息查看地图上展示")]),s._v(" "),n("blockquote",[n("p",[s._v("https://www.movable-type.co.uk/scripts/geohash.html")])])])]),s._v(" "),n("h1",{attrs:{id:"geopoint-点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#geopoint-点"}},[s._v("#")]),s._v(" Geopoint（点）")]),s._v(" "),n("h2",{attrs:{id:"如何指定一个地理位置信息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#如何指定一个地理位置信息"}},[s._v("#")]),s._v(" 如何指定一个地理位置信息")]),s._v(" "),n("p",[s._v("Elasticsearch中"),n("code",[s._v("geo_point")]),s._v("类型的数据字段支持以下5种方式录入地理位置数据，分别如下：")]),s._v(" "),n("p",[s._v("首先我们还是先定义一个索引，创建一个数据类型为"),n("code",[s._v("geo_point")]),s._v("的字段")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("创建索引")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUT my-index-000001\n{\n  "mappings": {\n    "properties": {\n      "text":{\n        "type": "text"\n      },\n      "location":{\n        "type": "geo_point"\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("作为一个对象传入位置信息")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUT my-index-000001/_doc/1\n{\n  "text": "Geopoint as an object",\n  "location": { \n    "lat": 41.12,\n    "lon": -71.34\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("字符串形式写入"),n("code",[s._v('"lat,lon"')])]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUT my-index-000001/_doc/2\n{\n  "text": "Geopoint as a string",\n  "location": "41.12,-71.34" \n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("geohash形式写入")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUT my-index-000001/_doc/3\n{\n  "text": "Geopoint as a geohash",\n  "location": "drm3btev3e86" \n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("数组"),n("code",[s._v("[lon,lat]")])]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('\nPUT my-index-000001/_doc/4\n{\n  "text": "Geopoint as an array",\n  "location": [ -71.34, 41.12 ] \n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("POINT 文本"),n("code",[s._v('"POINT(lon lat)"')])]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUT my-index-000001/_doc/5\n{\n  "text": "Geopoint as a WKT POINT primitive",\n  "location" : "POINT (-71.34 41.12)" \n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("基于一定地理位置边界的查询")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET my-index-000001/_search\n{\n  "query": {\n    "geo_bounding_box": { \n      "location": {\n        "top_left": {\n          "lat": 43,\n          "lon": -72\n        },\n        "bottom_right": {\n          "lat": 40,\n          "lon": -74\n        }\n      }\n    }\n  }\n}\n\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("通过上面的例子可以看出"),n("code",[s._v("geo_point")]),s._v("类型的字段可以同时接收五种参数形式的数据写入，并且丝毫不影响查询，就是这么强大，还不快用起来，温馨提醒，千万不要为了用而用哦")])])]),s._v(" "),n("h2",{attrs:{id:"geo-point-类型字段支持的参数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#geo-point-类型字段支持的参数"}},[s._v("#")]),s._v(" geo_point 类型字段支持的参数")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("ignore_malformed")]),s._v(" "),n("p",[s._v("默认"),n("code",[s._v("false")]),s._v(",写入文档时遇到不符合规范的地理位置信息字段值会抛出异常，如果为"),n("code",[s._v("true")]),s._v("，则会忽略。如果设置了"),n("code",[s._v("script")]),s._v("字段，该字段将不能使用")])]),s._v(" "),n("li",[n("p",[s._v("ignore_z_value")]),s._v(" "),n("p",[s._v("默认"),n("code",[s._v("true")]),s._v("，三维空间信息将被记录，但是只有经纬度的值能被索引，如果为"),n("code",[s._v("false")]),s._v("，写入文档时如果有超过二维的信息，抛出异常拒绝文档写入")])]),s._v(" "),n("li",[n("p",[s._v("index")]),s._v(" "),n("p",[s._v("是否可以被索引，默认"),n("code",[s._v("true")]),s._v(",如果为"),n("code",[s._v("false")]),s._v("，未建立索引的字段将不能被检索")])]),s._v(" "),n("li",[n("p",[s._v("null_value")]),s._v(" "),n("p",[s._v("默认值为"),n("code",[s._v("null")]),s._v("，如果设置为"),n("code",[s._v("null")]),s._v("，则意味着该字段是不存在的，如果使用了"),n("code",[s._v("script")]),s._v("，则该字段不可被设置")])]),s._v(" "),n("li",[n("p",[s._v("on_script_error")]),s._v(" "),n("p",[s._v("只有设置了"),n("code",[s._v("script")]),s._v("字段的时候才可以设置该字段，定义使用脚步发生错误时如何处理，默认"),n("code",[s._v("fail")]),s._v("，拒绝整个文档，但是会继续，在元数据字段中注册该字段")])]),s._v(" "),n("li",[n("p",[s._v("script")]),s._v(" "),n("p",[s._v("脚本字段，如果设置了该值，将索引该脚本执行之后的结果，如果在写文档的时候给该字段设置了值，文档将会被拒绝。脚本的格式与运行时相同，应该是一对"),n("code",[s._v("(lat,lon)")]),s._v("双值的形式")])])]),s._v(" "),n("h2",{attrs:{id:"在脚本中使用geopoints"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#在脚本中使用geopoints"}},[s._v("#")]),s._v(" 在脚本中使用geopoints")]),s._v(" "),n("p",[s._v("当在脚本中访问"),n("code",[s._v("geopoint")]),s._v("类型的值时，该值做为"),n("code",[s._v("GeoPoint")]),s._v("对象返回，可以使用如下方式读取")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("def geopoint = doc['location'].value;\ndef lat      = geopoint.lat;\ndef lon      = geopoint.lon;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("但是更推下如下这样读取")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("def lat      = doc['location'].lat;\ndef lon      = doc['location'].lon;\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h1",{attrs:{id:"geoshape-形状"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#geoshape-形状"}},[s._v("#")]),s._v(" Geoshape（形状）")]),s._v(" "),n("p",[s._v("对几何形状进行索引和查询（矩形和多边形），当索引的数据和查询包含除了点以外的形状时应该使用"),n("code",[s._v("geo_shape")]),s._v("类型")]),s._v(" "),n("p",[s._v("通过上面这俩类型的描述，我们可以得出一个结论，就是"),n("code",[s._v("geo_point")]),s._v("表示一个点，"),n("code",[s._v("geo_shape")]),s._v("表示多个点连接线组成的形状")]),s._v(" "),n("h2",{attrs:{id:"支持的映射参数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#支持的映射参数"}},[s._v("#")]),s._v(" 支持的映射参数")]),s._v(" "),n("p",[n("code",[s._v("geo_shape")]),s._v(" 映射将"),n("code",[s._v("GeoJSON")]),s._v("几何对象映射到"),n("code",[s._v("geo_shape")]),s._v("，要是用该映射类型，必须显式的设置，这句话意思就是我们使用该数据类型的时候必须明确指定索引类型")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("orientation")]),s._v(" "),n("p",[s._v("可选参数，WKT多边形的默认方向，默认"),n("code",[s._v("RIGHT")]),s._v("逆时针。"),n("code",[s._v("LEFT")]),s._v("顺时针")]),s._v(" "),n("p",[s._v("如果要指定"),n("code",[s._v("RGIHT")]),s._v("可以使用如下值设置")]),s._v(" "),n("ul",[n("li",[s._v("right")]),s._v(" "),n("li",[s._v("counterclockwise")]),s._v(" "),n("li",[s._v("ccw")])]),s._v(" "),n("p",[s._v("如果要指定"),n("code",[s._v("LEFT")]),s._v("可以使用如下值设置")]),s._v(" "),n("ul",[n("li",[s._v("left")]),s._v(" "),n("li",[s._v("clockwise")]),s._v(" "),n("li",[s._v("cw")])]),s._v(" "),n("blockquote",[n("p",[s._v("WKT(Well-known text)是一种文本标记语言，用于表示矢量几何对象、空间参照系统及空间参照系统之间的转换")])])]),s._v(" "),n("li",[n("p",[s._v("ignore_malformed")]),s._v(" "),n("p",[s._v("默认"),n("code",[s._v("false")]),s._v("，如果是不符合"),n("code",[s._v("GeoJSON")]),s._v("或者"),n("code",[s._v("WKT")]),s._v("的格式抛出异常，如果为"),n("code",[s._v("true")]),s._v("，则忽略")])]),s._v(" "),n("li",[n("p",[s._v("ignore_z_value")]),s._v(" "),n("p",[s._v("默认"),n("code",[s._v("true")]),s._v("，三维空间信息将被记录，但是只有经纬度的值能被索引，如果为"),n("code",[s._v("false")]),s._v("，写入文档时如果有超过二维的信息，抛出异常拒绝文档写入")])]),s._v(" "),n("li",[n("p",[s._v("Coerce")]),s._v(" "),n("p",[s._v("默认"),n("code",[s._v("false")]),s._v("，如果为"),n("code",[s._v("true")]),s._v("，如果是非封闭的多边形将自动闭合形成封闭的多边形")])])]),s._v(" "),n("h2",{attrs:{id:"创建索引"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建索引"}},[s._v("#")]),s._v(" 创建索引")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUT /example\n{\n  "mappings": {\n    "properties": {\n      "location": {\n        "type": "geo_shape"\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("h2",{attrs:{id:"输入类型"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#输入类型"}},[s._v("#")]),s._v(" 输入类型")]),s._v(" "),n("p",[s._v("地理位置形状信息可以使用"),n("code",[s._v("GeoJSON")]),s._v("或者"),n("code",[s._v("WKT")]),s._v("表示，下面是"),n("code",[s._v("GeoJSON")]),s._v("，"),n("code",[s._v("WKT")]),s._v("与"),n("code",[s._v("Elasticsearch")]),s._v("中类型的对应关系")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("GeoJSON Type")]),s._v(" "),n("th",[s._v("WKT Type")]),s._v(" "),n("th",[s._v("Elasticsearch Type")]),s._v(" "),n("th",[s._v("description")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("Point")]),s._v(" "),n("td",[s._v("POINT")]),s._v(" "),n("td",[s._v("Point")]),s._v(" "),n("td",[s._v("单一的经纬度坐标")])]),s._v(" "),n("tr",[n("td",[s._v("LineString")]),s._v(" "),n("td",[s._v("LINTSTRING")]),s._v(" "),n("td",[s._v("lingstring")]),s._v(" "),n("td",[s._v("给定两个点或多个点组成的任意直线")])]),s._v(" "),n("tr",[n("td",[s._v("Polygon")]),s._v(" "),n("td",[s._v("POLYGON")]),s._v(" "),n("td",[s._v("polygon")]),s._v(" "),n("td",[s._v("封闭的多边形，第一个点和最后一个点必须匹配，也就是"),n("code",[s._v("n+1")]),s._v("个点形成的"),n("code",[s._v("n")]),s._v("边多边形，至少"),n("code",[s._v("4")]),s._v("个顶点")])]),s._v(" "),n("tr",[n("td",[s._v("MultiPoint")]),s._v(" "),n("td",[s._v("MULTIPOINT")]),s._v(" "),n("td",[s._v("multipoint")]),s._v(" "),n("td",[s._v("一组不相连但是可能相关的点")])]),s._v(" "),n("tr",[n("td",[s._v("MultiLineString")]),s._v(" "),n("td",[s._v("MULTILINESTRING")]),s._v(" "),n("td",[s._v("multilinestring")]),s._v(" "),n("td",[s._v("单独的行字符串组成的数组")])]),s._v(" "),n("tr",[n("td",[s._v("MultiPolygon")]),s._v(" "),n("td",[s._v("MULTIPOLYGON")]),s._v(" "),n("td",[s._v("multipolygon")]),s._v(" "),n("td",[s._v("单独的多边形数组")])]),s._v(" "),n("tr",[n("td",[s._v("GeometryCollection")]),s._v(" "),n("td",[s._v("GEOMETRYCOLLECTION")]),s._v(" "),n("td",[s._v("geometrycollection")]),s._v(" "),n("td",[s._v("与multi开头的类型类似的一个GeoJSON形状，但是多个类型可以共同存在比如（Point和LineString同时存在）")])]),s._v(" "),n("tr",[n("td",[s._v("N/A")]),s._v(" "),n("td",[s._v("BBOX")]),s._v(" "),n("td",[s._v("envelope")]),s._v(" "),n("td",[s._v("仅指定左上角和右下角两个点组成的边框或包")])])])]),s._v(" "),n("p",[s._v("对于所有的类型都应该有子类型和字段坐标，"),n("strong",[s._v("在"),n("code",[s._v("GeoJSON")]),s._v("、"),n("code",[s._v("WKT")]),s._v("以及"),n("code",[s._v("Elasticsearch")]),s._v("中，坐标信息都是(经度，纬度)")]),s._v("，这与很多的地理信息API是不同的，"),n("strong",[s._v("地图地理信息API通常使用(纬度，经度)")]),s._v("，这一点是需要注意的一个地方，下面我将针对以上集中类型情况分别做一个写入数据的测试")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("点")]),s._v(" "),n("p",[s._v("点的话比较简单，就比如手机定位，或者某个建筑的位置信息")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# GeoJSON\nPOST /example/_doc\n{\n  "location" : {\n    "type" : "Point",\n    "coordinates" : [-77.03653, 38.897676]\n  }\n}\n# WKT\nPOST /example/_doc\n{\n  "location" : "POINT (-77.03653 38.897676)"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("线")]),s._v(" "),n("p",[s._v("由两个或者多个数组以上定义的行字符串，通过指定两个点，linestring将表示一条线，两个以上的点表示任意路径")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# GeoJSON\nPOST /example/_doc\n{\n  "location" : {\n    "type" : "LineString",\n    "coordinates" : [[-77.03653, 38.897676], [-77.009051, 38.889939]]\n  }\n}\n# WKT\nPOST /example/_doc\n{\n  "location" : "LINESTRING (-77.03653 38.897676, -77.009051 38.889939)"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("多边形")]),s._v(" "),n("p",[s._v("多边形是由多个点定义的，列表的第一个点和最后一个点必须相同")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# GeoJSON\nPOST /example/_doc\n{\n  "location" : {\n    "type" : "Polygon",\n    "coordinates" : [\n      [ [100.0, 0.0], [101.0, 0.0], [101.0, 1.0], [100.0, 1.0], [100.0, 0.0] ]\n    ]\n  }\n}\n# WKT\nPOST /example/_doc\n{\n  "location" : "POLYGON ((100.0 0.0, 101.0 0.0, 101.0 1.0, 100.0 1.0, 100.0 0.0))"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("p",[s._v("上面这个定义的是一个多边形，下面定义一个带洞的多边形，下面例子中，第一个数组代表多边形外部边界，第二个数组代表内部洞的边界")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# GeoJSON\nPOST /example/_doc\n{\n  "location" : {\n    "type" : "Polygon",\n    "coordinates" : [\n      [ [100.0, 0.0], [101.0, 0.0], [101.0, 1.0], [100.0, 1.0], [100.0, 0.0] ],\n      [ [100.2, 0.2], [100.8, 0.2], [100.8, 0.8], [100.2, 0.8], [100.2, 0.2] ]\n    ]\n  }\n}\n# WKT\nPOST /example/_doc\n{\n  "location" : "POLYGON ((100.0 0.0, 101.0 0.0, 101.0 1.0, 100.0 1.0, 100.0 0.0), (100.2 0.2, 100.8 0.2, 100.8 0.8, 100.2 0.8, 100.2 0.2))"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("多边形的方向")]),s._v(" "),n("p",[s._v("多边形的方向也就是顶点的顺序，有"),n("code",[s._v("Right")]),s._v("逆时针和"),n("code",[s._v("Left")]),s._v("顺时针，Elasticsearch使用多边形的方向来确认是否跨越了国际日期线(+-180度)")]),s._v(" "),n("p",[s._v("因为WKT没有指定或者强制默认方向，我们可以使用方向映射的参数"),n("code",[s._v("orientation")]),s._v("来设置多边形的方向")]),s._v(" "),n("p",[s._v("GeoJSON默认使用Right的方向,与参数"),n("code",[s._v("orientation")]),s._v("设置无关,GeoJSON规范要求外部多边形使用逆时针，内部多边形使用顺时针")]),s._v(" "),n("p",[s._v("但是可以使用文档级别的参数"),n("code",[s._v("orientation")]),s._v("覆盖来重写GeoJSON的默认方向,如下所示多边形方向就是"),n("code",[s._v("Left")])]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /example/_doc\n{\n  "location" : {\n    "type" : "Polygon",\n    "orientation" : "LEFT",\n    "coordinates" : [\n      [ [-177.0, 10.0], [176.0, 15.0], [172.0, 0.0], [176.0, -15.0], [-177.0, -10.0], [-177.0, 10.0] ]\n    ]\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("Elasticsearch 仅使用多边形的方向来确定是否跨越了国际日期线，如果一个多边形的最小经度与最大经度差值小于180，那多边形就没有跨越国际日期线，对多边形的方向也就不会有影响")]),s._v(" "),n("p",[s._v("如果多边形的最小经度与最大经度差值等于180或者大于180，则Elasticsearch会检查文档级别的orientation参数方向与默认的方向是否不同，如果方向不同，Elasticsearch会在跨越国际日期线的地方分割多边形")])]),s._v(" "),n("li",[n("p",[s._v("点的列表")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# GeoJSON\nPOST /example/_doc\n{\n  "location" : {\n    "type" : "MultiPoint",\n    "coordinates" : [\n      [102.0, 2.0], [103.0, 2.0]\n    ]\n  }\n}\n# WKT\nPOST /example/_doc\n{\n  "location" : "MULTIPOINT (102.0 2.0, 103.0 2.0)"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("线的列表")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# GeoJSON\nPOST /example/_doc\n{\n  "location" : {\n    "type" : "MultiLineString",\n    "coordinates" : [\n      [ [102.0, 2.0], [103.0, 2.0], [103.0, 3.0], [102.0, 3.0] ],\n      [ [100.0, 0.0], [101.0, 0.0], [101.0, 1.0], [100.0, 1.0] ],\n      [ [100.2, 0.2], [100.8, 0.2], [100.8, 0.8], [100.2, 0.8] ]\n    ]\n  }\n}\n#WKT\nPOST /example/_doc\n{\n  "location" : "MULTILINESTRING ((102.0 2.0, 103.0 2.0, 103.0 3.0, 102.0 3.0), (100.0 0.0, 101.0 0.0, 101.0 1.0, 100.0 1.0), (100.2 0.2, 100.8 0.2, 100.8 0.8, 100.2 0.8))"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("多个多边形")]),s._v(" "),n("p",[s._v("如下代表两个多边形，其中第二个多边形包含一个洞")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# GeoJSON\nPOST /example/_doc\n{\n  "location" : {\n    "type" : "MultiPolygon",\n    "coordinates" : [\n      [ [[102.0, 2.0], [103.0, 2.0], [103.0, 3.0], [102.0, 3.0], [102.0, 2.0]] ],\n      [ [[100.0, 0.0], [101.0, 0.0], [101.0, 1.0], [100.0, 1.0], [100.0, 0.0]],\n        [[100.2, 0.2], [100.8, 0.2], [100.8, 0.8], [100.2, 0.8], [100.2, 0.2]] ]\n    ]\n  }\n}\n# WKT\nPOST /example/_doc\n{\n  "location" : "MULTIPOLYGON (((102.0 2.0, 103.0 2.0, 103.0 3.0, 102.0 3.0, 102.0 2.0)), ((100.0 0.0, 101.0 0.0, 101.0 1.0, 100.0 1.0, 100.0 0.0), (100.2 0.2, 100.8 0.2, 100.8 0.8, 100.2 0.8, 100.2 0.2)))"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("集合对象")]),s._v(" "),n("p",[s._v("包含"),n("code",[s._v("Point")]),s._v("和"),n("code",[s._v("LineString")]),s._v("的例子")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# GeoJSON\nPOST /example/_doc\n{\n  "location" : {\n    "type": "GeometryCollection",\n    "geometries": [\n      {\n        "type": "Point",\n        "coordinates": [100.0, 0.0]\n      },\n      {\n        "type": "LineString",\n        "coordinates": [ [101.0, 0.0], [102.0, 1.0] ]\n      }\n    ]\n  }\n}\n# WKT\nPOST /example/_doc\n{\n  "location" : "GEOMETRYCOLLECTION (POINT (100.0 0.0), LINESTRING (101.0 0.0, 102.0 1.0))"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("envelope")]),s._v(" "),n("p",[s._v("指定对角线的多边形，格式为"),n("code",[s._v("[[minLon,maxLat],[maxLon,minLat]]")])]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /example/_doc\n{\n  "location" : {\n    "type" : "envelope",\n    "coordinates" : [ [100.0, 1.0], [101.0, 0.0] ]\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("下面使用WKT的BBOX类型，WKT的格式顺序为"),n("code",[s._v("minLon，maxLon，maxLat，minLat")])]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /example/_doc\n{\n  "location" : "BBOX (100.0, 102.0, 2.0, 0.0)"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("圆")]),s._v(" "),n("p",[n("code",[s._v("GeoJSON")]),s._v("和"),n("code",[s._v("WKT")]),s._v("都不支持一个点的半径圆类型，但是可以使用"),n("code",[s._v("circle ingest processor")]),s._v("来近似的模拟一个圆来作为一个多边形")])])]),s._v(" "),n("h2",{attrs:{id:"排序和检索"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#排序和检索"}},[s._v("#")]),s._v(" 排序和检索")]),s._v(" "),n("p",[s._v("由于形状的输入结构复杂度和索引表示形状的复杂性，目前不能对索引进行排序或者直接检索他们的字段，目前"),n("code",[s._v("geo_shape")]),s._v("只能通过"),n("code",[s._v("_source")]),s._v("来检索")]),s._v(" "),n("h1",{attrs:{id:"基于地理位置信息的范围查询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#基于地理位置信息的范围查询"}},[s._v("#")]),s._v(" 基于地理位置信息的范围查询")]),s._v(" "),n("p",[s._v("参考：https://kucw.github.io/blog/2019/12/elasticsearch-geo-point/")]),s._v(" "),n("h2",{attrs:{id:"geo-bounding-box-query-矩形过滤"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#geo-bounding-box-query-矩形过滤"}},[s._v("#")]),s._v(" Geo-bounding box query（矩形过滤）")]),s._v(" "),n("blockquote",[n("p",[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/8.1/query-dsl-geo-bounding-box-query.html")])]),s._v(" "),n("p",[s._v("可以对数据类型为"),n("code",[s._v("geo_point")]),s._v("和"),n("code",[s._v("geo_shape")]),s._v("的值在矩形边框内进行检索，找出落在矩形内的点")]),s._v(" "),n("h3",{attrs:{id:"geopoint-值的匹配"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#geopoint-值的匹配"}},[s._v("#")]),s._v(" Geopoint 值的匹配")]),s._v(" "),n("p",[s._v("下面是一个演示一个点在一个矩形边框范围的一个例子，首先还是创建一个索引")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("创建索引")]),s._v(" "),n("p",[s._v("索引包含两个字段，"),n("code",[s._v("desc")]),s._v("为地点的描述信息，"),n("code",[s._v("pin.location")]),s._v("为具体的地理位置信息")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUT /my_locations\n{\n  "mappings": {\n    "properties": {\n      "desc":{\n        "type": "text"\n      },\n      "pin": {\n        "properties": {\n          "location": {\n            "type": "geo_point"\n          }\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("插入一条测试数据，使用地图获取故宫博物院的坐标信息（位置信息与截图稍微有微微的偏差，为后期补充图片）")]),s._v(" "),n("p",[n("img",{attrs:{src:"/Users/cxt/Documents/personal/wechataccount/doc/database/elasticsearch/elasticsearch8.1/%E4%B8%80%E6%96%87%E5%BD%BB%E5%BA%95%E7%90%86%E8%A7%A3Elasticsearch%E4%B8%ADGeo%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.assets/image-20220826213039464.png",alt:"image-20220826213039464"}})]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUT /my_locations/_doc/1\n{\n  "desc":"故宫博物院",\n  "pin": {\n    "location": {\n      "lat": 39.92375,\n      "lon": 116.40348\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("定义下图所示的边界范围，矩形框内查询,"),n("code",[s._v("top_left")]),s._v("就是"),n("strong",[s._v("顶点1")]),s._v("，"),n("code",[s._v("bottom_right")]),s._v("就是"),n("strong",[s._v("顶点2")])]),s._v(" "),n("p",[n("img",{attrs:{src:"/Users/cxt/Documents/personal/wechataccount/doc/database/elasticsearch/elasticsearch8.1/%E4%B8%80%E6%96%87%E5%BD%BB%E5%BA%95%E7%90%86%E8%A7%A3Elasticsearch%E4%B8%ADGeo%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.assets/image-20220826220231873.png",alt:"image-20220826220231873"}})]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET my_locations/_search\n{\n  "query": {\n    "bool": {\n      "must": {\n        "match_all": {}\n      },\n      "filter": {\n        "geo_bounding_box": {\n          "pin.location": {\n            "top_left": {\n              "lat": 39.93872,\n              "lon": 116.37958\n            },\n            "bottom_right": {\n              "lat": 39.90924,\n              "lon": 116.42475\n            }\n          }\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("p",[s._v("查看返回结果可以获取到刚才插入的故宫博物院地点信息")]),s._v(" "),n("p",[n("img",{attrs:{src:"/Users/cxt/Documents/personal/wechataccount/doc/database/elasticsearch/elasticsearch8.1/%E4%B8%80%E6%96%87%E5%BD%BB%E5%BA%95%E7%90%86%E8%A7%A3Elasticsearch%E4%B8%ADGeo%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.assets/image-20220826213015079.png",alt:"image-20220826213015079"}})])])]),s._v(" "),n("h3",{attrs:{id:"geoshape-值的匹配"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#geoshape-值的匹配"}},[s._v("#")]),s._v(" Geoshape 值的匹配")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("新建索引")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUT /my_geoshapes\n{\n  "mappings": {\n    "properties": {\n      "desc":{\n        "type": "text"\n      },\n      "pin": {\n        "properties": {\n          "location": {\n            "type": "geo_shape"\n          }\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("插入测试数据,如下数据在地图展示如下，5个地理位置信息为图中矩形的顶点，顺时针第一个和最后一个保持相同如下地理位置信息数据的顺序依次为[1,2,3,4,1]")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code")]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"})])])]),s._v(" "),n("p",[s._v('PUT /my_geoshapes/_doc/1\n{\n"desc":"故宫博物院",\n"pin": {\n"location": {\n"type" : "polygon",\n"coordinates" : [[[116.39801,39.92905], [116.40774,39.92905], [116.40936,39.92063], [116.39761,39.92000], [116.39801,39.92905]]]\n}\n}\n}')]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('\n![image-20220826220300670](/Users/cxt/Documents/personal/wechataccount/doc/database/elasticsearch/elasticsearch8.1/一文彻底理解Elasticsearch中Geo数据类型.assets/image-20220826220300670.png)\n\n* 查询范围内形状匹配的值\n\n```text\nGET my_geoshapes/_search\n{\n  "query": {\n    "bool": {\n      "must": {\n        "match_all": {}\n      },\n      "filter": {\n        "geo_bounding_box": {\n          "pin.location": {\n            "top_left": {\n              "lat": 39.93872,\n              "lon": 116.37958\n            },\n            "bottom_right": {\n              "lat": 39.90794,\n              "lon": 116.42486\n            }\n          }\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br")])]),n("p",[s._v("上面的"),n("code",[s._v("top_left")]),s._v("对应的就是图中的"),n("strong",[s._v("顶点1")]),s._v("，"),n("code",[s._v("bottom_right")]),s._v("对应的就是图中的"),n("strong",[s._v("顶点2")])]),s._v(" "),n("p",[n("img",{attrs:{src:"/Users/cxt/Documents/personal/wechataccount/doc/database/elasticsearch/elasticsearch8.1/%E4%B8%80%E6%96%87%E5%BD%BB%E5%BA%95%E7%90%86%E8%A7%A3Elasticsearch%E4%B8%ADGeo%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.assets/image-20220826220314429.png",alt:"image-20220826220314429"}})]),s._v(" "),n("p",[s._v("检索结果如下")]),s._v(" "),n("p",[n("img",{attrs:{src:"/Users/cxt/Documents/personal/wechataccount/doc/database/elasticsearch/elasticsearch8.1/%E4%B8%80%E6%96%87%E5%BD%BB%E5%BA%95%E7%90%86%E8%A7%A3Elasticsearch%E4%B8%ADGeo%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.assets/image-20220826220431699.png",alt:"image-20220826220431699"}})]),s._v(" "),n("h2",{attrs:{id:"geo-distance-query-圆形过滤"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#geo-distance-query-圆形过滤"}},[s._v("#")]),s._v(" Geo-distance query（圆形过滤）")]),s._v(" "),n("blockquote",[n("p",[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/8.1/query-dsl-geo-distance-query.html#query-dsl-geo-distance-query")])]),s._v(" "),n("p",[s._v("以给定位置作圆点，画一个给定距离的圆，以匹配圆范围内的文档数据，下面我们用例子来说明这个圆形过滤")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("创建索引,"),n("code",[s._v("my_locations")]),s._v("测试"),n("code",[s._v("geo_point")]),s._v(","),n("code",[s._v("my_geoshapes")]),s._v("测试"),n("code",[s._v("geo_shape")])]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUT /my_locations\n{\n  "mappings": {\n    "properties": {\n      "desc":{\n        "type": "text"\n      },\n      "pin": {\n        "properties": {\n          "location": {\n            "type": "geo_point"\n          }\n        }\n      }\n    }\n  }\n}\n\nPUT /my_geoshapes\n{\n  "mappings": {\n    "properties": {\n      "desc":{\n        "type": "text"\n      },\n      "pin": {\n        "properties": {\n          "location": {\n            "type": "geo_shape"\n          }\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("插入一个测试数据，地点信息为"),n("strong",[s._v("西单大悦城")]),s._v("("),n("strong",[s._v("经纬度：116.37927 , 39.91706")]),s._v(")")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUT /my_locations/_doc/1\n{\n  "desc":"西单大悦城",\n  "pin": {\n    "location": {\n      "lat":39.91706 ,\n      "lon": 116.37927\n    }\n  }\n}\nPUT /my_geoshapes/_doc/1\n{\n  "desc":"西单大悦城",\n  "pin": {\n    "location": {\n      "type" : "polygon",\n      "coordinates" : [[[116.37855,39.91761], [116.38018,39.91756], [116.38024,39.91651], [116.37862,39.91636 ], [116.37855,39.91761]]]\n    }\n  }\n}\n\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("p",[n("img",{attrs:{src:"/Users/cxt/Documents/personal/wechataccount/doc/database/elasticsearch/elasticsearch8.1/%E4%B8%80%E6%96%87%E5%BD%BB%E5%BA%95%E7%90%86%E8%A7%A3Elasticsearch%E4%B8%ADGeo%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.assets/image-20220827140241176.png",alt:"image-20220827140241176"}})])]),s._v(" "),n("li",[n("p",[s._v("查询故宫博物院周边"),n("code",[s._v("5公里")]),s._v("的文档信息")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET /my_locations/_search\n{\n  "query": {\n    "bool": {\n      "must": {\n        "match_all": {}\n      },\n      "filter": {\n        "geo_distance": {\n          "distance": "5km",\n          "pin.location": {\n            "lat": 39.92402,\n            "lon": 116.4036\n          }\n        }\n      }\n    }\n  }\n}\nGET my_geoshapes/_search\n{\n  "query": {\n    "bool": {\n      "must": {\n        "match_all": {}\n      },\n      "filter": {\n        "geo_distance": {\n          "distance": "5km",\n          "pin.location": {\n            "lat": 39.92402,\n            "lon": 116.40360\n          }\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br")])]),n("p",[s._v("查看结果可以得到距离为周边3公里内是搜索不到的，大于3公里就可以搜索到我们定义的西单大悦城的地点信息")]),s._v(" "),n("p",[s._v("看下面例子，同时在"),n("code",[s._v("my_locations")]),s._v("和"),n("code",[s._v("my_geoshapes")]),s._v("两个索引中搜索故宫博物院周边5公里内的地点信息")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET my_locations,my_geoshapes/_search\n{\n  "query": {\n    "bool": {\n      "must": {\n        "match_all": {}\n      },\n      "filter": {\n        "geo_distance": {\n          "distance": "5km",\n          "pin.location": {\n            "lat": 39.92402,\n            "lon": 116.40360\n          }\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("p",[n("img",{attrs:{src:"/Users/cxt/Documents/personal/wechataccount/doc/database/elasticsearch/elasticsearch8.1/%E4%B8%80%E6%96%87%E5%BD%BB%E5%BA%95%E7%90%86%E8%A7%A3Elasticsearch%E4%B8%ADGeo%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.assets/image-20220828133631885.png",alt:"image-20220828133631885"}})])])]),s._v(" "),n("h3",{attrs:{id:"扩展知识"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#扩展知识"}},[s._v("#")]),s._v(" 扩展知识")]),s._v(" "),n("p",[s._v("在上文中我们也看到了，录入测试数据的方式支持多种，在使用过滤器查询数据的时候同样如此可以使用多种方式进行过滤，如下简单举例几种，比如")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("使用数组形式("),n("code",[s._v("经度，纬度")]),s._v(")")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET /my_locations/_search\n{\n  "query": {\n    "bool": {\n      "must": {\n        "match_all": {}\n      },\n      "filter": {\n        "geo_distance": {\n          "distance": "5km",\n          "pin.location": [ 116.40360,39.92402 ]\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("使用字符串("),n("code",[s._v("纬度，经度")]),s._v(")")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET /my_locations/_search\n{\n  "query": {\n    "bool": {\n      "must": {\n        "match_all": {}\n      },\n      "filter": {\n        "geo_distance": {\n          "distance": "5km",\n          "pin.location": "39.92402,116.40360"\n        }\n      }\n    }\n  }\n}\nGET /my_geoshapes/_search\n{\n  "query": {\n    "bool": {\n      "must": {\n        "match_all": {}\n      },\n      "filter": {\n        "geo_distance": {\n          "distance": "5km",\n          "pin.location": "39.92402,116.40360"\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("使用geohash")]),s._v(" "),n("p",[n("code",[s._v("geohash")]),s._v(" 生成可以参考文章开头帮助信息中生成"),n("code",[s._v("geohash")]),s._v("的网站，也可以复制如下链接到浏览器打开，任选其一即可")]),s._v(" "),n("blockquote",[n("p",[s._v("https://www.dcode.fr/geohash-coordinates")]),s._v(" "),n("p",[s._v("https://www.movable-type.co.uk/scripts/geohash.html")])]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET my_locations,my_geoshapes/_search\n{\n  "query": {\n    "bool": {\n      "must": {\n        "match_all": {}\n      },\n      "filter": {\n        "geo_distance": {\n          "distance": "5km",\n          "pin.location": "wx4g0gfw22x"\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])])])]),s._v(" "),n("h3",{attrs:{id:"过滤查询接收的参数说明"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#过滤查询接收的参数说明"}},[s._v("#")]),s._v(" 过滤查询接收的参数说明")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("distance")]),s._v(" "),n("p",[s._v("以指定的点为圆心，以"),n("code",[s._v("distance")]),s._v("的值为半径画圆，匹配圆内的地点信息数据，距离单位默认米(m),其他距离单位可以参考官网")]),s._v(" "),n("blockquote",[n("p",[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/8.1/api-conventions.html#distance-units")])])]),s._v(" "),n("li",[n("p",[s._v("distance_type")]),s._v(" "),n("p",[s._v("计算距离的方式，也就是"),n("code",[s._v("distance")]),s._v("生效的方式，默认是上述所说的为圆也就是弧形计算("),n("code",[s._v("arc")]),s._v(")，另一个可选值是平面的("),n("code",[s._v("plane")]),s._v(")，效率比"),n("code",[s._v("arc")]),s._v("快，但是精度有所损失，尤其是"),n("code",[s._v("distance")]),s._v("的值很大时或者两极处。"),n("code",[s._v("plane")]),s._v("比喻地球是平的，在赤道附近时精度是最佳的，靠近两级时精度略有损失。比如想找附近"),n("code",[s._v("5km")]),s._v("的地点，然后找到了"),n("code",[s._v("5.2km")]),s._v("的地点，这个误差取决于我们是否可以接受")])]),s._v(" "),n("li",[n("p",[s._v("_name")]),s._v(" "),n("p",[s._v("该查询语句的名称")])]),s._v(" "),n("li",[n("p",[s._v("validation_method")]),s._v(" "),n("p",[s._v("是否接受错误的地点坐标信息")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("STRICT")]),s._v(" "),n("code",[s._v("默认值")]),s._v("，抛出异常")]),s._v(" "),n("li",[n("code",[s._v("COERCE")]),s._v(" 尝试修正错误坐标信息为正确的坐标")]),s._v(" "),n("li",[n("code",[s._v("IGNORE_MALFORMED")]),s._v(" 允许无效的错误的地点坐标信息")])])])]),s._v(" "),n("p",[n("code",[s._v("geo_distance")]),s._v("的过滤请求可以匹配一篇文档中的多个地点值，只要有一个地点值匹配，该文档就会被返回")]),s._v(" "),n("p",[n("code",[s._v("ignore_unmapped")]),s._v("字段的值设置为"),n("code",[s._v("true")]),s._v("，查询时如果字段"),n("code",[s._v("不匹配")]),s._v("，"),n("code",[s._v("会忽略报错，返回空文档")]),s._v("；如果设置为"),n("code",[s._v("false")]),s._v("，遇到不匹配的字段会 "),n("code",[s._v("抛出异常")])]),s._v(" "),n("p",[s._v("如下示例，匹配"),n("code",[s._v("pin.location1")]),s._v("字段，我们知道该字段在索引中是不存在的，所以当"),n("code",[s._v("ignore_unmapped")]),s._v("设置为"),n("code",[s._v("true")]),s._v("时返回空文档，设置为"),n("code",[s._v("false")]),s._v("时抛出异常")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET my_locations,my_geoshapes/_search\n{\n  "query": {\n    "bool": {\n      "must": {\n        "match_all": {}\n      },\n      "filter": {\n        "geo_distance": {\n          "ignore_unmapped":true,\n          "_name":"zuiyuquery",\n          "distance": "5km",\n          "pin.location1": "wx4g0gfw22x"\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("h2",{attrs:{id:"geo-polygon-query-自定义多边形过滤"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#geo-polygon-query-自定义多边形过滤"}},[s._v("#")]),s._v(" Geo-polygon query（自定义多边形过滤）")]),s._v(" "),n("blockquote",[n("p",[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/8.1/query-dsl-geo-polygon-query.html")])]),s._v(" "),n("p",[s._v("多边形过滤，顾名思义就是查询条件定义个多边形，返回该多边形区域内的点的文档信息")]),s._v(" "),n("blockquote",[n("p",[s._v("官网已经说明es7.12版本开始废弃，推荐使用geoshape，参考后文的 geoshape query")])]),s._v(" "),n("p",[s._v("该查询接收的参数有如下")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("_name")]),s._v(" "),n("p",[s._v("该查询语句的名称")])]),s._v(" "),n("li",[n("p",[s._v("validation_method")]),s._v(" "),n("p",[s._v("是否接受错误的地点坐标信息")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("STRICT")]),s._v(" "),n("code",[s._v("默认值")]),s._v("，抛出异常")]),s._v(" "),n("li",[n("code",[s._v("COERCE")]),s._v(" 尝试修正错误坐标信息为正确的坐标")]),s._v(" "),n("li",[n("code",[s._v("IGNORE_MALFORMED")]),s._v(" 允许无效的错误的地点坐标信息")])])])]),s._v(" "),n("p",[s._v("需要注意的是，查询的字段需要设置为"),n("code",[s._v("geo_point")]),s._v("类型,同样"),n("code",[s._v("ignore_unmapped")]),s._v("字段的值设置为"),n("code",[s._v("true")]),s._v("，查询时如果字段"),n("code",[s._v("不匹配")]),s._v("，"),n("code",[s._v("会忽略报错，返回空文档")]),s._v("；如果设置为"),n("code",[s._v("false")]),s._v("，遇到不匹配的字段会 "),n("code",[s._v("抛出异常")])]),s._v(" "),n("ul",[n("li",[n("p",[s._v("我们先插入一条故宫位置的信息文档")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUT /my_locations/_doc/2\n{\n  "desc":"故宫",\n  "pin":{\n    "location":"39.92307,116.40291"\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])])])]),s._v(" "),n("p",[s._v("如下是对"),n("code",[s._v("pin.location")]),s._v("字段定义一个三条边的形状的过滤查询语句,三个点顺序【1，2，3】排列,此时该 查询会返回故宫的信息，但是刚才定的西单大悦城的信息就不会返回")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET my_locations/_search\n{\n  "query": {\n    "bool": {\n      "must": {\n        "match_all": {}\n      },\n      "filter": {\n        "geo_polygon": {\n          "pin.location": {\n            "points": [\n              { "lat": 39.93506, "lon": 116.41043 },\n              { "lat": 39.91101, "lon": 116.42383 },\n              { "lat": 39.92217, "lon": 116.35836 }\n            ]\n          }\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("p",[n("img",{attrs:{src:"/Users/cxt/Documents/personal/wechataccount/doc/database/elasticsearch/elasticsearch8.1/%E4%B8%80%E6%96%87%E5%BD%BB%E5%BA%95%E7%90%86%E8%A7%A3Elasticsearch%E4%B8%ADGeo%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.assets/image-20220828150654638.png",alt:"image-20220828150654638"}})]),s._v(" "),n("p",[s._v("同样的自定义查询语句也可以接收【字符串,数组，geohash】的地点信息")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("字符串")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# 字符串\nGET my_locations/_search\n{\n  "query": {\n    "bool": {\n      "must": {\n        "match_all": {}\n      },\n      "filter": {\n        "geo_polygon": {\n          "pin.location": {\n            "points": [\n              "39.93506,116.41043","39.91101,116.42383","39.92217,116.35836"\n            ]\n          }\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("数组")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# 数组\nGET my_locations/_search\n{\n  "query": {\n    "bool": {\n      "must": {\n        "match_all": {}\n      },\n      "filter": {\n        "geo_polygon": {\n          "pin.location": {\n            "points": [\n              [116.41043,39.93506],\n              [116.42383,39.91101],\n              [116.35836,39.92217]\n            ]\n          }\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("geohash")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('# geohash\n\nGET my_locations/_search\n{\n  "query": {\n    "bool": {\n      "must": {\n        "match_all": {}\n      },\n      "filter": {\n        "geo_polygon": {\n          "pin.location": {\n            "points": [\n              "wx4g0vzqxdg",\n             "39.91101,116.42383",\n             "39.92217,116.35836"\n            ]\n          }\n        }\n      }\n    }\n  }\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])])])]),s._v(" "),n("h2",{attrs:{id:"geoshape-query-形状查询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#geoshape-query-形状查询"}},[s._v("#")]),s._v(" Geoshape query（形状查询）")]),s._v(" "),n("blockquote",[n("p",[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/8.1/query-dsl-geo-shape-query.html")])]),s._v(" "),n("p",[s._v("支持geo_shape和geo_point两种字段类型的过滤查询")]),s._v(" "),n("p",[s._v("形状查询，支持传入一个完整图形形状的数据或者提前写入的图形形状数据，首先还是先演示一下如何使用传入的图形形状数据检索")]),s._v(" "),n("h3",{attrs:{id:"输入图形形状查询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#输入图形形状查询"}},[s._v("#")]),s._v(" 输入图形形状查询")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("定义索引,"),n("code",[s._v("geo_shape")]),s._v("字段")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('\nPUT /example\n{\n  "mappings": {\n    "properties": {\n      "location": {\n        "type": "geo_shape"\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("插入测试数据")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /example/_doc?refresh\n{\n  "name": "东单",\n  "location": {\n    "type": "point",\n    "coordinates": [ 116.426466,39.914743]\n  }\n}\nPOST /example/_doc?refresh\n{\n  "name": "天安门东",\n  "location": {\n    "type": "point",\n    "coordinates": [ 116.40771,39.914079]\n  }\n}\nPOST /example/_doc?refresh\n{\n  "name": "天安门西",\n  "location": {\n    "type": "point",\n    "coordinates": [ 116.397936,39.913802]\n  }\n}\nPOST /example/_doc?refresh\n{\n  "name": "西单",\n  "location": {\n    "type": "point",\n    "coordinates": [ 116.383132,39.913581]\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("过滤检索，返回文档中形状与检索形状相交的文档数据,如下查询语句返回经度"),n("code",[s._v("116-117")]),s._v("之间，纬度"),n("code",[s._v("39-40")]),s._v("之间的文档")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET /example/_search\n{\n  "query": {\n    "bool": {\n      "must": {\n        "match_all": {}\n      },\n      "filter": {\n        "geo_shape": {\n          "location": {\n            "shape": {\n              "type": "envelope",\n              "coordinates": [ [116.0,40.0 ], [ 117.0,39.0 ] ]\n            },\n            "relation": "within"\n          }\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("下面是geo_point类型字段的demo")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUT /example_points\n{\n  "mappings": {\n    "properties": {\n      "location": {\n        "type": "geo_point"\n      }\n    }\n  }\n}\n\nPUT /example_points/_doc/1?refresh\n{\n  "name": "Wind &amp; Wetter, Berlin, Germany",\n  "location": [13.400544, 52.530286]\n}\n\nPUT /example_points/_doc/1?refresh\n{\n  "name": "东单",\n  "location": [116.426466,39.914743]\n}\nPUT /example_points/_doc/2?refresh\n{\n  "name": "天安门东",\n  "location": [116.40771,39.914079]\n}\nPUT /example_points/_doc/3?refresh\n{\n  "name": "天安门西",\n  "location": [116.397936,39.913802]\n}\nPUT /example_points/_doc/4?refresh\n{\n  "name": "西单",\n  "location": [116.383132,39.913581]\n}\n\nGET /example_points/_search\n{\n  "query": {\n    "bool": {\n      "must": {\n        "match_all": {}\n      },\n      "filter": {\n        "geo_shape": {\n          "location": {\n            "shape": {\n              "type": "envelope",\n              "coordinates": [ [ 116.0, 40.0 ], [ 117.0, 39.0 ] ]\n            },\n            "relation": "intersects"\n          }\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br")])]),n("p",[s._v("通过上面两个不同字段的检索demo，我们应该也发现了，relation这个的值我们竟然使用的不一样，那么他们有什么区别呢，各自代表的含义如下：")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("INTERSECTS")])]),s._v(" "),n("p",[n("code",[s._v("默认值")]),s._v("，返回字段类型为"),n("code",[s._v("geo_shape")]),s._v("或者"),n("code",[s._v("geo_point")]),s._v("与检索的"),n("code",[s._v("图形相交")]),s._v("的文档")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("DISJOINT")])]),s._v(" "),n("p",[s._v("返回字段类型为"),n("code",[s._v("geo_shape")]),s._v("或者"),n("code",[s._v("geo_point")]),s._v("与检索图形"),n("code",[s._v("不相交")]),s._v("的文档")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("WITHIN")])]),s._v(" "),n("p",[s._v("返回字段类型为"),n("code",[s._v("geo_shape")]),s._v("或者"),n("code",[s._v("geo_point``在检索图形范围内")]),s._v("的文档，不支持线的几何图形")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("CONTAINS")])]),s._v(" "),n("p",[s._v("返回文档中字段类型为"),n("code",[s._v("geo_shape")]),s._v("或者"),n("code",[s._v("geo_point")]),s._v("的信息 "),n("code",[s._v("包含检索图形形状")]),s._v("的文档")])])]),s._v(" "),n("h3",{attrs:{id:"预置图形形状查询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#预置图形形状查询"}},[s._v("#")]),s._v(" 预置图形形状查询")]),s._v(" "),n("p",[s._v("预置就是提前设置好图形的数据，保存在索引中，查询时根据提前定义好图形的名称来过滤数据，首先它有如下几个参数")]),s._v(" "),n("ul",[n("li",[s._v("id 预索引形状的id")]),s._v(" "),n("li",[s._v("index 预索引形状所在的索引位置，默认"),n("code",[s._v("shapes")])]),s._v(" "),n("li",[s._v("path  预索引形状所在索引中的字段名称，默认"),n("code",[s._v("shape")])]),s._v(" "),n("li",[s._v("routing  可选，预索引形状的路由参数")])]),s._v(" "),n("p",[s._v("查询示例如下")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUT /shapes\n{\n  "mappings": {\n    "properties": {\n      "location": {\n        "type": "geo_shape"\n      }\n    }\n  }\n}\n\nPUT /shapes/_doc/oneline\n{\n  "location": {\n    "type": "envelope",\n    "coordinates" : [[116.0, 40.0], [ 117.0, 39.0]]\n  }\n}\n\nGET /example/_search\n{\n  "query": {\n    "bool": {\n      "filter": {\n        "geo_shape": {\n          "location": {\n            "indexed_shape": {\n              "index": "shapes",\n              "id": "oneline",\n              "path": "location"\n            }\n          }\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br")])]),n("h1",{attrs:{id:"基于地理位置信息或者到中心点距离的聚合统计"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#基于地理位置信息或者到中心点距离的聚合统计"}},[s._v("#")]),s._v(" 基于地理位置信息或者到中心点距离的聚合统计")]),s._v(" "),n("h2",{attrs:{id:"geo网格聚合"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#geo网格聚合"}},[s._v("#")]),s._v(" Geo网格聚合")]),s._v(" "),n("blockquote",[n("p",[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/8.1/search-aggregations-bucket-geohashgrid-aggregation.html")])]),s._v(" "),n("p",[s._v("网格聚合，将字段类型为"),n("code",[s._v("geo_point")]),s._v("或者"),n("code",[s._v("geo_shape")]),s._v("的数据划分为一个个的单元格，也就是一个个的单元格的桶中，既然是单元格那也就是有大有小，也就是高精确度与低精确度值，精度值的范围为"),n("code",[s._v("1-12")]),s._v(" ，"),n("code",[s._v("1")]),s._v("表示精确度最低，范围最大，"),n("code",[s._v("12")]),s._v("表示精确度最高但是范围也最小，甚至可能出现百万个以上的桶的聚合，所以这个是需要注意的地方，如果精确度要求比较高的话，可以使用"),n("code",[s._v("geo_bounding box query")]),s._v("过滤缩小聚合范围。网格聚合通过"),n("code",[s._v("geohash")]),s._v("来实现，通过指定聚合类型为"),n("code",[s._v("geohash_grid")]),s._v("来实现网格聚合，下面是演示demo")]),s._v(" "),n("h3",{attrs:{id:"geo-point"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#geo-point"}},[s._v("#")]),s._v(" geo_point")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("创建索引")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUT /gugong_map\n{\n  "mappings": {\n    "properties": {\n      "location": {\n        "type": "geo_point"\n      }\n    }\n  }\n}\n\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("插入测试数据")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /gugong_map/_bulk?refresh\n{"index":{"_id":1}}\n{"location": "39.91466,116.42633", "name": "东单"}\n{"index":{"_id":2}}\n{"location": "39.914105,116.407934", "name": "天安门东"}\n{"index":{"_id":3}}\n{"location": "39.913662,116.398232", "name": "天安门西"}\n{"index":{"_id":4}}\n{"location": "39.913441,116.3835", "name": "西单A"}\n{"index":{"_id":5}}\n{"location": "39.913385,116.380625", "name": "西单B"}\n{"index":{"_id":6}}\n{"location": "39.922184,116.380338", "name": "灵境胡同"}\n\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("聚合查询")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /gugong_map/_search?size=0\n{\n  "aggregations": {\n    "large-grid": {\n      "geohash_grid": {\n        "field": "location",\n        "precision": 5\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("使用过滤条件的聚合")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /gugong_map/_search?size=0\n{\n  "aggregations": {\n    "zoomed-in": {\n      "filter": {\n        "geo_bounding_box": {\n          "location": {\n            "top_left": "39.930429,116.379619",\n            "bottom_right": "39.909788,116.403981"\n          }\n        }\n      },\n      "aggregations": {\n        "zoom1": {\n          "geohash_grid": {\n            "field": "location",\n            "precision": 8\n          }\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("使用过滤参数的聚合")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /gugong_map/_search?size=0\n{\n  "aggregations": {\n    "tiles-in-bounds": {\n      "geohash_grid": {\n        "field": "location",\n        "precision": 8,\n        "bounds": {\n            "top_left": "39.930429,116.379619",\n            "bottom_right": "39.909788,116.403981"\n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])])])]),s._v(" "),n("h3",{attrs:{id:"geo-shape"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#geo-shape"}},[s._v("#")]),s._v(" geo_shape")]),s._v(" "),n("p",[s._v("geo_shape与geo_point类似")]),s._v(" "),n("h3",{attrs:{id:"支持参数"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#支持参数"}},[s._v("#")]),s._v(" 支持参数")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("field")]),s._v(" 聚合的字段名称， "),n("code",[s._v("必选字段")])]),s._v(" "),n("li",[n("code",[s._v("precision")]),s._v("  精度值，范围从"),n("code",[s._v("1-12")]),s._v("，也可以使用距离比如"),n("code",[s._v("1km")]),s._v("，"),n("code",[s._v("10m")]),s._v("这种距离值  "),n("code",[s._v("可选")])]),s._v(" "),n("li",[n("code",[s._v("bounds")]),s._v(" 等价于"),n("code",[s._v("geo_bounding box query")]),s._v(" 过滤边界的参数值设置 "),n("code",[s._v("可选")])]),s._v(" "),n("li",[n("code",[s._v("size")]),s._v(" 返回聚合桶的数量 "),n("code",[s._v("可选")])]),s._v(" "),n("li",[n("code",[s._v("shard_size")]),s._v("   为了对返回的聚合结果进行更精确的计算，该值为每个分片返回的聚合桶的数量，默认"),n("code",[s._v("max(10,(size x number-of-shards))")]),s._v("的最大值")])]),s._v(" "),n("h2",{attrs:{id:"圆点距离聚合"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#圆点距离聚合"}},[s._v("#")]),s._v(" 圆点距离聚合")]),s._v(" "),n("blockquote",[n("p",[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/8.1/search-aggregations-bucket-geodistance-aggregation.html")])]),s._v(" "),n("p",[s._v("给定一圆点，以给出距离为半径画圆，将落在圆内的数据按照到原点的距离聚合，我们可以定一个起始值，一组范围的值来规定聚合桶的范围，下面跟我一起来看下如何使用到圆点距离的聚合")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("创建一个索引保存故宫周围地铁站的信息")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUT /gugong_map\n{\n  "mappings": {\n    "properties": {\n      "location": {\n        "type": "geo_point"\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("插入故宫周围地铁站信息")]),s._v(" "),n("p",[s._v("聚合 的字段必须显示设置为"),n("code",[s._v("geo_point")]),s._v("类型,")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /gugong_map/_bulk?refresh\n{"index":{"_id":1}}\n{"location": [116.426259,39.91488], "name": "东单站"}\n{"index":{"_id":2}}\n{"location": [116.426259,39.91488], "name": "天安门东站"}\n{"index":{"_id":3}}\n{"location": [116.397873,39.913828], "name": "天安门西站"}\n{"index":{"_id":4}}\n{"location": [116.383284,39.913441], "name": "西单站"}\n{"index":{"_id":5}}\n{"location": [116.379979,39.922184], "name": "灵境胡同站"}\n{"index":{"_id":6}}\n{"location": [116.379979,39.922184], "name": "西四站"}\n{"index":{"_id":7}}\n{"location": [116.39313,39.939668], "name": "北海北站"}\n{"index":{"_id":8}}\n{"location": [116.410665,39.939944], "name": "南锣鼓巷站"}\n{"index":{"_id":9}}\n{"location": [116.417061,39.92224], "name": "金鱼胡同站"}\n{"index":{"_id":10}}\n{"location": [116.418067,39.916097], "name": "王府井站"}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("根据地铁站距离到故宫的距离进行聚合查询")]),s._v(" "),n("p",[s._v("聚合的默认距离单位是"),n("code",[s._v("m")]),s._v(",我们可以通过"),n("code",[s._v("unit")]),s._v("参数指定")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /gugong_map/_search?size=0\n{\n  "aggs": {\n    "rings_around_amsterdam": {\n      "geo_distance": {\n        "field": "location",\n        "origin": [116.403119,39.923568],\n        "ranges": [\n          { "to": 1000 },\n          { "from": 1000, "to": 2000 },\n          { "from": 2000 }\n        ]\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("通过指定"),n("code",[s._v("unit")]),s._v("距离单位聚合")]),s._v(" "),n("p",[n("code",[s._v("unit")]),s._v(" 支持"),n("code",[s._v("mi")]),s._v("(miles),"),n("code",[s._v("in")]),s._v("(inches),"),n("code",[s._v("yd")]),s._v("(yards),"),n("code",[s._v("km")]),s._v("(kilometers),"),n("code",[s._v("cm")]),s._v("(centimeters),"),n("code",[s._v("mm")]),s._v("(millimeters),"),n("code",[s._v("m")]),s._v("(meters)")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /gugong_map/_search?size=0\n{\n  "aggs": {\n    "rings": {\n      "geo_distance": {\n        "field": "location",\n        "origin": [116.403119,39.923568],\n        "unit": "m", \n        "ranges": [\n          { "to": 1000 },\n          { "from": 1000, "to": 2000 },\n          { "from": 2000 }\n        ]\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("指定聚合计算方式，精确度")]),s._v(" "),n("p",[n("code",[s._v("arc")]),s._v("，默认，精确度高")]),s._v(" "),n("p",[n("code",[s._v("plane")]),s._v(" 精确度低，距离仅时推荐使用，比如"),n("code",[s._v("5km")]),s._v("内")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /gugong_map/_search?size=0\n{\n  "aggs": {\n    "rings": {\n      "geo_distance": {\n        "field": "location",\n        "origin": [116.403119,39.923568],\n        "unit": "m",\n        "distance_type": "plane",\n        "ranges": [\n          { "to": 1000 },\n          { "from": 1000, "to": 2000 },\n          { "from": 2000 }\n        ]\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])])]),s._v(" "),n("li",[n("p",[s._v("对聚合桶返回唯一的key")]),s._v(" "),n("p",[s._v("设置"),n("code",[s._v("keyed")]),s._v("为"),n("code",[s._v("true")]),s._v("返回唯一的"),n("code",[s._v("key")]),s._v("与聚合桶绑定，如果为"),n("code",[s._v("false")]),s._v("返回的就是聚合桶的数组")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /gugong_map/_search?size=0\n{\n  "aggs": {\n    "rings_around_amsterdam": {\n      "geo_distance": {\n        "field": "location",\n        "origin": [\n          116.403119,\n          39.923568\n        ],\n        "ranges": [\n          {\n            "to": 1000\n          },\n          {\n            "from": 1000,\n            "to": 2000\n          },\n          {\n            "from": 2000\n          }\n        ],\n        "keyed": true\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br")])]),n("p",[s._v("还可以 "),n("code",[s._v("自定义聚合桶")]),s._v("的名称")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /gugong_map/_search?size=0\n{\n  "aggs": {\n    "rings_around_amsterdam": {\n      "geo_distance": {\n        "field": "location",\n        "origin": [\n          116.403119,\n          39.923568\n        ],\n        "ranges": [\n          { "to": 1000, "key": "first_ring" },\n          { "from": 1000, "to": 2000, "key": "second_ring" },\n          { "from": 2000, "key": "third_ring" }\n        ],\n        "keyed": true\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])])])]),s._v(" "),n("h1",{attrs:{id:"将地理位置信息加入到分数计算中"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#将地理位置信息加入到分数计算中"}},[s._v("#")]),s._v(" 将地理位置信息加入到分数计算中")]),s._v(" "),n("blockquote",[n("p",[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/8.1/query-dsl-function-score-query.html")])]),s._v(" "),n("ul",[n("li",[s._v("首先字段必须是"),n("code",[s._v("geo_point")]),s._v("类型")]),s._v(" "),n("li",[s._v("提供一个圆心点的位置坐标")]),s._v(" "),n("li",[n("code",[s._v("scale")]),s._v("和"),n("code",[s._v("offset")]),s._v("必须设置")])]),s._v(" "),n("p",[s._v("满足以上三点就可以加入到分数计算中,gauss 使用高斯函数来衰减，具体参考官网，"),n("code",[s._v("后面专门出一期衰减函数的文章")])]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET gugong_map/_search\n{\n  "query": {\n    "function_score": {\n      "gauss": {\n        "location": {\n          "origin": [116.385728,39.870814], \n          "scale": "3000m",// origin + offset，衰减率，也就得分衰减的速度\n          "offset": "3000m",// 3000m以内的文档得分不处理，3000m以外的文档得分慢慢衰减  \n          "decay": 0.5  // 从 origin 衰减到 scale 所得的评分_score，默认为0.5         \n        }\n      }\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("h1",{attrs:{id:"基于距离信息的排序"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#基于距离信息的排序"}},[s._v("#")]),s._v(" 基于距离信息的排序")]),s._v(" "),n("blockquote",[n("p",[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/8.1/sort-search-results.html#geo-sorting")])]),s._v(" "),n("p",[s._v("需要指定圆点的坐标信息，根据到原点的距离进行排序,比如如下语句，查询"),n("code",[s._v("name")]),s._v("字段带"),n("code",[s._v("站")]),s._v("的，根据到"),n("code",[s._v("北京南站")]),s._v("(116.385728,39.870814)的距离升序输出,坐标信息，与"),n("code",[s._v("geo_point")]),s._v("支持的方式相同，可以为"),n("code",[s._v("数组")]),s._v("，"),n("code",[s._v("字符串")]),s._v("，"),n("code",[s._v("对象")]),s._v("，"),n("code",[s._v("geohash")])]),s._v(" "),n("ul",[n("li",[n("p",[n("code",[s._v("_geo_distance")]),s._v("指定为geo类型字段排序的类型")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("order")]),s._v(" 升序还是降序 ，"),n("code",[s._v("asc")]),s._v("、"),n("code",[s._v("desc")])])]),s._v(" "),n("li",[n("p",[n("code",[s._v("unit")]),s._v(" 距离排序使用的单位，默认"),n("code",[s._v("m")])])]),s._v(" "),n("li",[n("p",[n("code",[s._v("mode")]),s._v(" 如果一个地点值的字段包含多个地理位置信息，怎么取值，如果升序排序时选最短距离，降序排序时选最长距离的。支持"),n("code",[s._v("min")]),s._v(","),n("code",[s._v("max")]),s._v(","),n("code",[s._v("median")]),s._v(","),n("code",[s._v("avg")])])]),s._v(" "),n("li",[n("p",[n("code",[s._v("distance_type")]),s._v("默认 "),n("code",[s._v("arc")]),s._v(" 精确度高，"),n("code",[s._v("plane")]),s._v(" 速度快，再靠近两级附近或者距离远时精度低")])]),s._v(" "),n("li",[n("p",[n("code",[s._v("ignore_unmapped")]),s._v(" 字段不存在映射时是否报错，默认"),n("code",[s._v("false")]),s._v("，未匹配时报错，如果为"),n("code",[s._v("true")]),s._v("，等于使用"),n("code",[s._v("unmapped_type")]),s._v(" 的字段排序")]),s._v(" "),n("blockquote",[n("p",[s._v("地理位置排序时，如果文档中没有地理位置信息，距离被默认为 "),n("code",[s._v("infinity")])])])])]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET gugong_map/_search\n{\n  "sort" : [\n    {\n      "_geo_distance" : {\n          "location" : [116.385728,39.870814],\n          "order" : "asc",\n          "unit" : "km",\n          "mode" : "min",\n          "distance_type" : "arc",\n          "ignore_unmapped": true\n      }\n    }\n  ],\n  "query" : {\n    "term" : { "name" : "站" }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("h1",{attrs:{id:"总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),n("p",[s._v("在上面的章节中，我们由浅入深的学习了"),n("code",[s._v("geo_point")]),s._v("和"),n("code",[s._v("geo_shape")]),s._v("两种"),n("code",[s._v("geo")]),s._v("数据类型，以及如何通过对这两字段进行检索，聚合排序，相信大家读到这也基本有了一个概念了，再深点还是要去看官方文档了，不过实践是检验真理的唯一标准，多实操吧，总没有错，加油！！！")]),s._v(" "),n("p",[s._v("如果有写的不对的地方欢迎指出哦！！！共同进步才能走的更远！！！")])])}),[],!1,null,null,null);n.default=t.exports}}]);