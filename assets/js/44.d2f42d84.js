(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{452:function(s,n,a){"use strict";a.r(n);var e=a(2),t=Object(e.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[n("img",{attrs:{src:"%E5%8D%8A%E5%B9%B4%E6%97%B6%E9%97%B4%E8%81%9A%E5%90%88%E6%A1%B6%E6%95%B0%E9%87%8F%E6%8C%87%E5%AE%9A%E9%83%BD%E5%BF%98%E4%BA%86.assets/image-20240724165633022.png",alt:"image-20240724165633022"}})]),s._v(" "),n("h2",{attrs:{id:"一、版本"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一、版本"}},[s._v("#")]),s._v(" 一、版本")]),s._v(" "),n("ul",[n("li",[s._v("elasticsearch 8.13")])]),s._v(" "),n("h2",{attrs:{id:"二、背景"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二、背景"}},[s._v("#")]),s._v(" 二、背景")]),s._v(" "),n("p",[s._v("最近接到一个需求，将 MySQL 中的数据迁移到 Elasticsearch 中，并且相关的业务接口全部切换为使用 Elasticsearch 实现。")]),s._v(" "),n("p",[s._v("其中有个统计的功能，先根据 "),n("code",[s._v("group")]),s._v(" 进行分组，然后对每个组内对象的 "),n("code",[s._v("type")]),s._v(" 值进行分组统计。")]),s._v(" "),n("blockquote",[n("p",[s._v("举个例子：对学生进行统计，相当于先按照班级分组，在统计每个班级里面男女生的人数。")])]),s._v(" "),n("p",[s._v("我一想切换到 Elasticsearch 中，相当于嵌套子聚合，一个聚合查询就出来结果，半小时搞定这个接口。")]),s._v(" "),n("p",[n("img",{attrs:{src:"%E5%8D%8A%E5%B9%B4%E6%97%B6%E9%97%B4%E8%81%9A%E5%90%88%E6%A1%B6%E6%95%B0%E9%87%8F%E6%8C%87%E5%AE%9A%E9%83%BD%E5%BF%98%E4%BA%86.assets/image-20240724133525183.png",alt:"image-20240724133525183"}})]),s._v(" "),n("h2",{attrs:{id:"三、问题来了"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三、问题来了"}},[s._v("#")]),s._v(" 三、问题来了")]),s._v(" "),n("h3",{attrs:{id:"_3-1、初始化数据"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-1、初始化数据"}},[s._v("#")]),s._v(" 3.1、初始化数据")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUT zuiyu_index\n{\n  "settings": {\n    "number_of_replicas": 1,\n    "number_of_shards": 1\n  },\n  "mappings": {\n    "properties": {\n      "group": {\n        "type": "text",\n        "fields": {\n          "keyword": {\n            "type": "keyword",\n            "ignore_above": 256\n          }\n        }\n      },\n      "type": {\n        "type": "long"\n      }\n    }\n  }\n}\n\nPOST _bulk\n{ "index" : { "_index" : "zuiyu_index", "_id" : "1" } }\n{ "group" : "1","type":1 ,"sort":1}\n{ "index" : { "_index" : "zuiyu_index", "_id" : "2" } }\n{ "group" : "1","type":2 ,"sort":1}\n{ "index" : { "_index" : "zuiyu_index", "_id" : "3" } }\n{ "group" : "1","type":3 ,"sort":1}\n{ "index" : { "_index" : "zuiyu_index", "_id" : "4" } }\n{ "group" : "2","type":1 ,"sort":1}\n{ "index" : { "_index" : "zuiyu_index", "_id" : "5" } }\n{ "group" : "2","type":1 ,"sort":1}\n{ "index" : { "_index" : "zuiyu_index", "_id" : "6" } }\n{ "group" : "2","type":1 ,"sort":1}\n{ "index" : { "_index" : "zuiyu_index", "_id" : "7" } }\n{ "group" : "3","type":2 ,"sort":1}\n{ "index" : { "_index" : "zuiyu_index", "_id" : "8" } }\n{ "group" : "4","type":1 ,"sort":1}\n{ "index" : { "_index" : "zuiyu_index", "_id" : "9" } }\n{ "group" : "5","type":1 ,"sort":1}\n{ "index" : { "_index" : "zuiyu_index", "_id" : "10" } }\n{ "group" : "6","type":1 ,"sort":1}\n{ "index" : { "_index" : "zuiyu_index", "_id" : "11" } }\n{ "group" : "7","type":1 ,"sort":1}\n{ "index" : { "_index" : "zuiyu_index", "_id" : "12" } }\n{ "group" : "8","type":1 ,"sort":1}\n{ "index" : { "_index" : "zuiyu_index", "_id" : "13" } }\n{ "group" : "9","type":1 ,"sort":1}\n{ "index" : { "_index" : "zuiyu_index", "_id" : "14" } }\n{ "group" : "10","type":1 ,"sort":1}\n{ "index" : { "_index" : "zuiyu_index", "_id" : "15" } }\n{ "group" : "10","type":2 ,"sort":1}\n{ "index" : { "_index" : "zuiyu_index", "_id" : "16" } }\n{ "group" : "11","type":1 ,"sort":1}\n{ "index" : { "_index" : "zuiyu_index", "_id" : "17" } }\n{ "group" : "11","type":3 ,"sort":1}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br")])]),n("p",[s._v("像这种简单的一条 sql 就出来结果的业务，我一般都是先写个 sql 语句，然后根据 sql 再写代码。所以这里我就先写了个DSL语句。")]),s._v(" "),n("h3",{attrs:{id:"_3-2、聚合查询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-2、聚合查询"}},[s._v("#")]),s._v(" 3.2、聚合查询")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET zuiyu_index/_search\n{\n  "aggregations": {\n    "agg_group": {\n      "aggregations": {\n        "agg_type": {\n          "terms": {\n            "field": "type"\n          }\n        }\n      },\n      "terms": {\n        "field": "group.keyword"\n      }\n    }\n  },\n  "query": {\n    "bool": {\n      "must": [\n        {\n          "terms": {\n            "group.keyword": ["1","2","3","4","5","6","7","8","9","10","11"]\n          }\n        }\n      ]\n    }\n  },\n  "size":0\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br")])]),n("p",[s._v("同学们可以看一下上面的语句有问题吗，如果你能发现问题，那么这篇文章也希望你能看下去，也许会有意想不到的收获。")]),s._v(" "),n("blockquote",[n("p",[s._v("提示一下：就像标题所说，可以关心一下聚合桶的数量。")])]),s._v(" "),n("h2",{attrs:{id:"四、发现问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#四、发现问题"}},[s._v("#")]),s._v(" 四、发现问题")]),s._v(" "),n("p",[s._v("上述 DSL 语句执行之后，"),n("strong",[s._v("大眼一看")]),s._v(" ，结果 OK，是我想要的，那就按这个逻辑直接写 Java 代码。\n上述 DSL 语句中聚合操作对应的 Java 代码如下：")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(' Aggregation aggType = Aggregation.of(agg -> agg.terms(t -> t.field("type")));\n Aggregation aggGroup = Aggregation.of(agg -> agg.terms(t -> t.field("group"))\n                .aggregations("agg_type", aggType));\n                \n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("做接口数据层的迁移，最简单的就是修改完业务代码之后直接对比返回结果，保持返回结果的一致，这样的修改对于前端来说没有影响。")]),s._v(" "),n("p",[s._v("所以，修改完代码之后直接拿接口的返回值与修改之前的版本进行比对，验证业务逻辑是否一致。直接 F12 控制台，找到该接口的返回值，复制，粘贴到对比工具中，进行对比。")]),s._v(" "),n("blockquote",[n("p",[s._v("此处使用的对比工具是 Beyond Compare 。")])]),s._v(" "),n("p",[s._v("通过对比返回结果发现，"),n("strong",[s._v("聚合桶的数量少了一个")]),s._v("。")]),s._v(" "),n("p",[s._v("上面的例子中，我们的预期结果是，最外层 group 的分组最少11个，排除 group 不存在的情况。这里 terms 中条件 group 在索引中都已存在。")]),s._v(" "),n("p",[s._v("然后我就赶紧再去执行了一遍上面 DSL 语句，一个一个的验证聚合桶，发现返回结果中竟然没有 "),n("code",[s._v("group=9")]),s._v(" 的桶存在。")]),s._v(" "),n("p",[s._v("DSL 返回结果如下")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('{\n  "took": 2,\n  "timed_out": false,\n  "_shards": {\n    "total": 1,\n    "successful": 1,\n    "skipped": 0,\n    "failed": 0\n  },\n  "hits": {\n    "total": {\n      "value": 17,\n      "relation": "eq"\n    },\n    "max_score": null,\n    "hits": []\n  },\n  "aggregations": {\n    "agg_group": {\n      "doc_count_error_upper_bound": 0,\n      "sum_other_doc_count": 1,\n      "buckets": [\n        {\n          "key": "1",\n          "doc_count": 3,\n          "agg_type": {\n            "doc_count_error_upper_bound": 0,\n            "sum_other_doc_count": 0,\n            "buckets": [\n              {\n                "key": 1,\n                "doc_count": 1\n              },\n              {\n                "key": 2,\n                "doc_count": 1\n              },\n              {\n                "key": 3,\n                "doc_count": 1\n              }\n            ]\n          }\n        },\n        {\n          "key": "2",\n          "doc_count": 3,\n          "agg_type": {\n            "doc_count_error_upper_bound": 0,\n            "sum_other_doc_count": 0,\n            "buckets": [\n              {\n                "key": 1,\n                "doc_count": 3\n              }\n            ]\n          }\n        },\n        {\n          "key": "10",\n          "doc_count": 2,\n          "agg_type": {\n            "doc_count_error_upper_bound": 0,\n            "sum_other_doc_count": 0,\n            "buckets": [\n              {\n                "key": 1,\n                "doc_count": 1\n              },\n              {\n                "key": 2,\n                "doc_count": 1\n              }\n            ]\n          }\n        },\n        {\n          "key": "11",\n          "doc_count": 2,\n          "agg_type": {\n            "doc_count_error_upper_bound": 0,\n            "sum_other_doc_count": 0,\n            "buckets": [\n              {\n                "key": 1,\n                "doc_count": 1\n              },\n              {\n                "key": 3,\n                "doc_count": 1\n              }\n            ]\n          }\n        },\n        {\n          "key": "3",\n          "doc_count": 1,\n          "agg_type": {\n            "doc_count_error_upper_bound": 0,\n            "sum_other_doc_count": 0,\n            "buckets": [\n              {\n                "key": 2,\n                "doc_count": 1\n              }\n            ]\n          }\n        },\n        {\n          "key": "4",\n          "doc_count": 1,\n          "agg_type": {\n            "doc_count_error_upper_bound": 0,\n            "sum_other_doc_count": 0,\n            "buckets": [\n              {\n                "key": 1,\n                "doc_count": 1\n              }\n            ]\n          }\n        },\n        {\n          "key": "5",\n          "doc_count": 1,\n          "agg_type": {\n            "doc_count_error_upper_bound": 0,\n            "sum_other_doc_count": 0,\n            "buckets": [\n              {\n                "key": 1,\n                "doc_count": 1\n              }\n            ]\n          }\n        },\n        {\n          "key": "6",\n          "doc_count": 1,\n          "agg_type": {\n            "doc_count_error_upper_bound": 0,\n            "sum_other_doc_count": 0,\n            "buckets": [\n              {\n                "key": 1,\n                "doc_count": 1\n              }\n            ]\n          }\n        },\n        {\n          "key": "7",\n          "doc_count": 1,\n          "agg_type": {\n            "doc_count_error_upper_bound": 0,\n            "sum_other_doc_count": 0,\n            "buckets": [\n              {\n                "key": 1,\n                "doc_count": 1\n              }\n            ]\n          }\n        },\n        {\n          "key": "8",\n          "doc_count": 1,\n          "agg_type": {\n            "doc_count_error_upper_bound": 0,\n            "sum_other_doc_count": 0,\n            "buckets": [\n              {\n                "key": 1,\n                "doc_count": 1\n              }\n            ]\n          }\n        }\n      ]\n    }\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br"),n("span",{staticClass:"line-number"},[s._v("92")]),n("br"),n("span",{staticClass:"line-number"},[s._v("93")]),n("br"),n("span",{staticClass:"line-number"},[s._v("94")]),n("br"),n("span",{staticClass:"line-number"},[s._v("95")]),n("br"),n("span",{staticClass:"line-number"},[s._v("96")]),n("br"),n("span",{staticClass:"line-number"},[s._v("97")]),n("br"),n("span",{staticClass:"line-number"},[s._v("98")]),n("br"),n("span",{staticClass:"line-number"},[s._v("99")]),n("br"),n("span",{staticClass:"line-number"},[s._v("100")]),n("br"),n("span",{staticClass:"line-number"},[s._v("101")]),n("br"),n("span",{staticClass:"line-number"},[s._v("102")]),n("br"),n("span",{staticClass:"line-number"},[s._v("103")]),n("br"),n("span",{staticClass:"line-number"},[s._v("104")]),n("br"),n("span",{staticClass:"line-number"},[s._v("105")]),n("br"),n("span",{staticClass:"line-number"},[s._v("106")]),n("br"),n("span",{staticClass:"line-number"},[s._v("107")]),n("br"),n("span",{staticClass:"line-number"},[s._v("108")]),n("br"),n("span",{staticClass:"line-number"},[s._v("109")]),n("br"),n("span",{staticClass:"line-number"},[s._v("110")]),n("br"),n("span",{staticClass:"line-number"},[s._v("111")]),n("br"),n("span",{staticClass:"line-number"},[s._v("112")]),n("br"),n("span",{staticClass:"line-number"},[s._v("113")]),n("br"),n("span",{staticClass:"line-number"},[s._v("114")]),n("br"),n("span",{staticClass:"line-number"},[s._v("115")]),n("br"),n("span",{staticClass:"line-number"},[s._v("116")]),n("br"),n("span",{staticClass:"line-number"},[s._v("117")]),n("br"),n("span",{staticClass:"line-number"},[s._v("118")]),n("br"),n("span",{staticClass:"line-number"},[s._v("119")]),n("br"),n("span",{staticClass:"line-number"},[s._v("120")]),n("br"),n("span",{staticClass:"line-number"},[s._v("121")]),n("br"),n("span",{staticClass:"line-number"},[s._v("122")]),n("br"),n("span",{staticClass:"line-number"},[s._v("123")]),n("br"),n("span",{staticClass:"line-number"},[s._v("124")]),n("br"),n("span",{staticClass:"line-number"},[s._v("125")]),n("br"),n("span",{staticClass:"line-number"},[s._v("126")]),n("br"),n("span",{staticClass:"line-number"},[s._v("127")]),n("br"),n("span",{staticClass:"line-number"},[s._v("128")]),n("br"),n("span",{staticClass:"line-number"},[s._v("129")]),n("br"),n("span",{staticClass:"line-number"},[s._v("130")]),n("br"),n("span",{staticClass:"line-number"},[s._v("131")]),n("br"),n("span",{staticClass:"line-number"},[s._v("132")]),n("br"),n("span",{staticClass:"line-number"},[s._v("133")]),n("br"),n("span",{staticClass:"line-number"},[s._v("134")]),n("br"),n("span",{staticClass:"line-number"},[s._v("135")]),n("br"),n("span",{staticClass:"line-number"},[s._v("136")]),n("br"),n("span",{staticClass:"line-number"},[s._v("137")]),n("br"),n("span",{staticClass:"line-number"},[s._v("138")]),n("br"),n("span",{staticClass:"line-number"},[s._v("139")]),n("br"),n("span",{staticClass:"line-number"},[s._v("140")]),n("br"),n("span",{staticClass:"line-number"},[s._v("141")]),n("br"),n("span",{staticClass:"line-number"},[s._v("142")]),n("br"),n("span",{staticClass:"line-number"},[s._v("143")]),n("br"),n("span",{staticClass:"line-number"},[s._v("144")]),n("br"),n("span",{staticClass:"line-number"},[s._v("145")]),n("br"),n("span",{staticClass:"line-number"},[s._v("146")]),n("br"),n("span",{staticClass:"line-number"},[s._v("147")]),n("br"),n("span",{staticClass:"line-number"},[s._v("148")]),n("br"),n("span",{staticClass:"line-number"},[s._v("149")]),n("br"),n("span",{staticClass:"line-number"},[s._v("150")]),n("br"),n("span",{staticClass:"line-number"},[s._v("151")]),n("br"),n("span",{staticClass:"line-number"},[s._v("152")]),n("br"),n("span",{staticClass:"line-number"},[s._v("153")]),n("br"),n("span",{staticClass:"line-number"},[s._v("154")]),n("br"),n("span",{staticClass:"line-number"},[s._v("155")]),n("br"),n("span",{staticClass:"line-number"},[s._v("156")]),n("br"),n("span",{staticClass:"line-number"},[s._v("157")]),n("br"),n("span",{staticClass:"line-number"},[s._v("158")]),n("br"),n("span",{staticClass:"line-number"},[s._v("159")]),n("br"),n("span",{staticClass:"line-number"},[s._v("160")]),n("br"),n("span",{staticClass:"line-number"},[s._v("161")]),n("br"),n("span",{staticClass:"line-number"},[s._v("162")]),n("br"),n("span",{staticClass:"line-number"},[s._v("163")]),n("br"),n("span",{staticClass:"line-number"},[s._v("164")]),n("br"),n("span",{staticClass:"line-number"},[s._v("165")]),n("br"),n("span",{staticClass:"line-number"},[s._v("166")]),n("br"),n("span",{staticClass:"line-number"},[s._v("167")]),n("br"),n("span",{staticClass:"line-number"},[s._v("168")]),n("br"),n("span",{staticClass:"line-number"},[s._v("169")]),n("br"),n("span",{staticClass:"line-number"},[s._v("170")]),n("br"),n("span",{staticClass:"line-number"},[s._v("171")]),n("br"),n("span",{staticClass:"line-number"},[s._v("172")]),n("br"),n("span",{staticClass:"line-number"},[s._v("173")]),n("br"),n("span",{staticClass:"line-number"},[s._v("174")]),n("br"),n("span",{staticClass:"line-number"},[s._v("175")]),n("br"),n("span",{staticClass:"line-number"},[s._v("176")]),n("br"),n("span",{staticClass:"line-number"},[s._v("177")]),n("br"),n("span",{staticClass:"line-number"},[s._v("178")]),n("br"),n("span",{staticClass:"line-number"},[s._v("179")]),n("br"),n("span",{staticClass:"line-number"},[s._v("180")]),n("br"),n("span",{staticClass:"line-number"},[s._v("181")]),n("br"),n("span",{staticClass:"line-number"},[s._v("182")]),n("br")])]),n("p",[s._v("到了这，其实我还没想到是什么原因造成的，然后看了好几遍的聚合语句，都没有发现问题。一度的自我怀疑，聚合不是这样用的吗，嵌套的聚合难道还有花样？")]),s._v(" "),n("ul",[n("li",[s._v("查阅官方文档")])]),s._v(" "),n("p",[s._v("官方文档肯定是最权威的，所以去官方文档看看吧，是不是可以给自己点灵感，找到解决方案。")]),s._v(" "),n("p",[s._v("首先去的是如下地址：")]),s._v(" "),n("blockquote",[n("p",[n("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html#run-sub-aggs",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html#run-sub-aggs"),n("OutboundLink")],1)])]),s._v(" "),n("p",[n("img",{attrs:{src:"%E5%8D%8A%E5%B9%B4%E6%97%B6%E9%97%B4%E8%81%9A%E5%90%88%E6%A1%B6%E6%95%B0%E9%87%8F%E6%8C%87%E5%AE%9A%E9%83%BD%E5%BF%98%E4%BA%86.assets/image-20240724160254610.png",alt:"image-20240724160254610"}})]),s._v(" "),n("p",[s._v("官方给的代码示例好简单，确实没毛病，对我没啥启发，告辞转下个网页。")]),s._v(" "),n("p",[s._v("还是这个网页，回到页面顶端，有一个 "),n("code",[s._v("Bucket")]),s._v(" 字样的地方，点进去。")]),s._v(" "),n("p",[n("img",{attrs:{src:"%E5%8D%8A%E5%B9%B4%E6%97%B6%E9%97%B4%E8%81%9A%E5%90%88%E6%A1%B6%E6%95%B0%E9%87%8F%E6%8C%87%E5%AE%9A%E9%83%BD%E5%BF%98%E4%BA%86.assets/image-20240724160445630.png",alt:"image-20240724160445630"}})]),s._v(" "),n("blockquote",[n("p",[n("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket.html"),n("OutboundLink")],1)])]),s._v(" "),n("p",[n("img",{attrs:{src:"%E5%8D%8A%E5%B9%B4%E6%97%B6%E9%97%B4%E8%81%9A%E5%90%88%E6%A1%B6%E6%95%B0%E9%87%8F%E6%8C%87%E5%AE%9A%E9%83%BD%E5%BF%98%E4%BA%86.assets/image-20240724160654499.png",alt:"image-20240724160654499"}})]),s._v(" "),n("p",[s._v("在这个页面，发现可以通过 "),n("code",[s._v("search.max_buckets")]),s._v(" 设置请求返回聚合桶的总数，然后我脑海中那丢失的记忆回来了。")]),s._v(" "),n("p",[s._v("想起了在 Elasticsearch 聚合时，聚合桶的返回数量是可以指定的，但是怎么指定，参数是什么，我又忘了。")]),s._v(" "),n("p",[n("img",{attrs:{src:"%E5%8D%8A%E5%B9%B4%E6%97%B6%E9%97%B4%E8%81%9A%E5%90%88%E6%A1%B6%E6%95%B0%E9%87%8F%E6%8C%87%E5%AE%9A%E9%83%BD%E5%BF%98%E4%BA%86.assets/image-20240724160935103.png",alt:"image-20240724160935103"}})]),s._v(" "),n("p",[s._v("但是大方向肯定是这个了，我就开始找相关的资料，翻阅官网关于聚合的文档，终于在官方文档的嵌套聚合中找到了相关的说明。")]),s._v(" "),n("blockquote",[n("p",[n("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-composite-aggregation.html#_size",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-composite-aggregation.html#_size"),n("OutboundLink")],1)])]),s._v(" "),n("p",[n("img",{attrs:{src:"%E5%8D%8A%E5%B9%B4%E6%97%B6%E9%97%B4%E8%81%9A%E5%90%88%E6%A1%B6%E6%95%B0%E9%87%8F%E6%8C%87%E5%AE%9A%E9%83%BD%E5%BF%98%E4%BA%86.assets/image-20240724161335819.png",alt:"image-20240724161335819"}})]),s._v(" "),n("p",[s._v("大体意思就是"),n("code",[s._v("size")]),s._v("参数可以控制返回聚合桶的数量，默认 "),n("code",[s._v("10")]),s._v("。")]),s._v(" "),n("p",[s._v("但是这里也没有给出示例，我还是不会用啊。")]),s._v(" "),n("p",[s._v("毕竟咱也是有点 ES 基础的，内心其实已经有了想法，大概知道怎么用了，只是还得需要确认下。")]),s._v(" "),n("p",[s._v("最后想起来之前写过关于聚合的文章，抱着试试看的态度，在回顾一下吧。")]),s._v(" "),n("blockquote",[n("p",[n("a",{attrs:{href:"https://mp.weixin.qq.com/s/18bz77nwgC_tF8l_jYD3CA",target:"_blank",rel:"noopener noreferrer"}},[s._v("聚合在Elasticsearch中的使用及示例验证"),n("OutboundLink")],1)])]),s._v(" "),n("p",[s._v("发文日期，2023年8月2日，真是老了，才半年多的时间都忘了，好了回到主题。")]),s._v(" "),n("p",[s._v("在这篇文档中，发现了 "),n("code",[s._v("size")]),s._v(" 参数的使用，在这里终于确认，聚合桶数量需要指定，并且根据自己的查询条件进行设置，或直接设置一个最大值兼容自己所有的聚合请求。")]),s._v(" "),n("p",[s._v("所以修改之后的 DSL 语句如下：")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('GET zuiyu_index/_search\n{\n  "aggregations": {\n    "agg_group": {\n      "aggregations": {\n        "agg_type": {\n          "terms": {\n            "field": "type"\n          }\n        }\n      },\n      "terms": {\n        "field": "group.keyword",\n        "size": 11\n      }\n    }\n  },\n  "query": {\n    "bool": {\n      "must": [\n        {\n          "terms": {\n            "group.keyword": ["1","2","3","4","5","6","7","8","9","10","11"]\n          }\n        }\n      ]\n    }\n  },\n  "size":0\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br")])]),n("p",[n("img",{attrs:{src:"%E5%8D%8A%E5%B9%B4%E6%97%B6%E9%97%B4%E8%81%9A%E5%90%88%E6%A1%B6%E6%95%B0%E9%87%8F%E6%8C%87%E5%AE%9A%E9%83%BD%E5%BF%98%E4%BA%86.assets/image-20240724162044360.png",alt:"image-20240724162044360"}})]),s._v(" "),n("p",[s._v("相对应的 Java 代码也修改:")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(' Aggregation aggType = Aggregation.of(agg -> agg.terms(t -> t.field("type")));\n Aggregation aggGroup = Aggregation.of(agg -> agg.terms(t -> t.field("group").size(groupList.size())\n                .aggregations("agg_type", aggType));\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("ul",[n("li",[s._v("groupList.size() 为 terms 查询条件值的数量。")])]),s._v(" "),n("h2",{attrs:{id:"五、search-max-buckets"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#五、search-max-buckets"}},[s._v("#")]),s._v(" 五、search.max_buckets")]),s._v(" "),n("p",[s._v("可以通过 "),n("code",[s._v("_cluster")]),s._v(" 的 API 设置此参数。")]),s._v(" "),n("div",{staticClass:"language-text line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUT _cluster/settings\n{\n  "transient": {\n    "search.max_buckets":100\n  }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("blockquote",[n("p",[s._v("此处使用的是 "),n("code",[s._v("transient")]),s._v(" ，还可以使用 "),n("code",[s._v("persistent")]),s._v(",他俩的区别就是"),n("code",[s._v("transient")]),s._v(" 的配置会在集群重启之后失效，"),n("code",[s._v("persistent")]),s._v("会持久化保存。")]),s._v(" "),n("p",[s._v("其中这个参数在之前的索引分片分配策略一文中讲过了，还没看过的可以跳过去看一下，链接我放下面。")]),s._v(" "),n("p",[n("a",{attrs:{href:"https://mp.weixin.qq.com/s/Rlu-GDNwnAUR3tzJYkm5Aw",target:"_blank",rel:"noopener noreferrer"}},[s._v("Elasticsearch Index Shard Allocation 索引分片分配策略"),n("OutboundLink")],1)])]),s._v(" "),n("h2",{attrs:{id:"六、总结"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#六、总结"}},[s._v("#")]),s._v(" 六、总结")]),s._v(" "),n("p",[s._v("本文通过 demo 示例，从发现聚合桶数量丢失，到排查产生丢失的问题，最后通过 "),n("code",[s._v("size")]),s._v(" 参数解决聚合桶数量丢失问题的过程。")]),s._v(" "),n("p",[s._v("意外收获的是一次请求返回聚合桶数量的总数也是可以通过 "),n("code",[s._v("search.max_buckets")]),s._v("设置的。")]),s._v(" "),n("p",[s._v("日常的积累固然重要，熟悉官方文档中相关 API 的位置也是必不可少的。")]),s._v(" "),n("p",[s._v("工作中你遇到问题是如何排查的呢，会不会查阅官网文档呢？欢迎在评论区沟通交流，大家一起学习进步！")]),s._v(" "),n("h2",{attrs:{id:"参考链接"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[s._v("#")]),s._v(" 参考链接")]),s._v(" "),n("p",[n("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html"),n("OutboundLink")],1),s._v(" "),n("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket.html"),n("OutboundLink")],1)]),s._v(" "),n("p",[n("a",{attrs:{href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-composite-aggregation.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-composite-aggregation.html"),n("OutboundLink")],1)]),s._v(" "),n("p",[n("a",{attrs:{href:"https://mp.weixin.qq.com/s/18bz77nwgC_tF8l_jYD3CA",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://mp.weixin.qq.com/s/18bz77nwgC_tF8l_jYD3CA"),n("OutboundLink")],1)]),s._v(" "),n("p",[n("a",{attrs:{href:"https://mp.weixin.qq.com/s/Rlu-GDNwnAUR3tzJYkm5Aw",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://mp.weixin.qq.com/s/Rlu-GDNwnAUR3tzJYkm5Aw"),n("OutboundLink")],1)])])}),[],!1,null,null,null);n.default=t.exports}}]);